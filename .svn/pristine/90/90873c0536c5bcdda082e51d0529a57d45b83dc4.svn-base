var commonJs = require('../../../utils/common'), initBase = commonJs.initBase,
  ajax = commonJs.ajax, app = getApp(), location = wx.getStorageSync('location');
Page({
  /**
   * 页面的初始数据
   */
  data: {
    indexmenu: [
    ],
    dealData: [
    ],
    indicatorDots: true,
    autoplay: true,
    interval: 3000,
    duration: 100,
    kbList: [],
    kbPage: 1,
    kbTotalPage: 0,
    kbTotal:'',
    sbList: [],
    sbPage: 1,
    sbTotalPage: 0,
    sbTotal:'',
    isMessage: false,
    isLoad:false,
    listMsg: '',
    bidList: [], // [{ isCollect: false }, { isCollect: true }, { isCollect: true }, { isCollect: true }, { isCollect: true },],
    banner: [
    ],
    bidType: 'kb',
    site: location.site,
    code:location.code,
    pageUrl:'/pages/homePage/index/index'
  },
  fetchArea(e){
    var val = e.detail.val, city = val.cityObject;
    wx.setStorageSync('location', {
      name: city.NAME == '全部' ? city.parentName : city.NAME,
      parent: city.parentName,
      code: val.AREA_CODE,
      site: val.site
    })
    this.setData({
      code: val.AREA_CODE,
      kbList:[],
      sbList: [], 
      kbPage:1,
      sbPage:1
    })
    this.fetchBidList(true)
    this.getSumData()
  },
  fetchSearch(e) {
    wx.navigateTo({ url:'../projectSearchList/projectSearchList?name='+e.detail.val})
  },
  fetchBidList(flag = false) {
    var that = this, todayTime = commonJs.DateFormat('yyyy-MM-dd'), type = that.data.bidType;
    if (flag) {
      //今日开标
      ajax({
        url: '/Search/GetData/GetDataHandler.ashx',
        data: {
          method: 'Web.XCX_GetJiaoYiList',
          pageindex:1,
          pagesize: 10,
          or: 'OPEN_TIME',
          OPEN_TIME_START: todayTime,
          OPEN_TIME_END: todayTime,
          AREA_CODE:this.data.code
        }
      }).then((res) => {
        var data = [...res.data.data.data], total = res.data.data.total,
          totalPage = Math.ceil(total / 10), isMessage = false, listMsg='';
        if (data.length) {
          if (totalPage == 1) {
            isMessage = true
            listMsg = '已获取全部数据'
          }
          that.setData({
            kbList: data,
            kbTotalPage: totalPage,
            kbTotal: total
          })
        } else {
          listMsg = '暂无数据';
          isMessage=true;
          that.setData({
            kbList: [],
            kbTotalPage: 1,
            kbTotal: 0
          })
        }
        if(type=='kb'){
          this.setData({
            bidList: data,
            listMsg: listMsg,
            isMessage: isMessage,
            isLoad: false
          })
        }
      })
      //正在报名
      ajax({
        url: '/Search/GetData/GetDataHandler.ashx',
        data: {
          method: 'Web.XCX_GetJiaoYiList_BaoMin',
          pageindex: 1,
          pagesize: 10,
          or: 'PUBLISHED_TIME',
          // PUBLISHED_TIME_START: todayTime,
          // PUBLISHED_TIME_END: todayTime,
          AREA_CODE: this.data.code
        }
      }).then((res) => {
        var data = [...res.data.data.data], total = res.data.data.total,
          totalPage = Math.ceil(total / 10), isMessage = false, listMsg = '';
        if (data.length) {
          if (totalPage == 1) {
            isMessage = true
            listMsg = '已获取全部数据'
          }
          that.setData({
            sbList: data,
            sbTotalPage: totalPage,
            sbTotal: total
          })
        } else {
          listMsg = '暂无数据';
          isMessage = true;
          that.setData({
            sbList: [],
            sbTotalPage: 1,
            sbTotal: 0
          })
        }
        if (type == 'sb') {
          this.setData({
            bidList: data,
            listMsg: listMsg,
            isMessage: isMessage,
            isLoad: false
          })
        }
      })
    }else{
      let initData = [],
        bidType = {
          kb: 'kbList',
          kbTotal: 'kbTotalPage',
          sb: 'sbList',
          sbTotal: 'sbTotalPage'
        },
        param;
      if (type == 'kb') {
        param = {
          method: 'Web.XCX_GetJiaoYiList',
          pageindex: that.data.kbPage,
          pagesize: 10,
          or: 'OPEN_TIME',
          OPEN_TIME_START: todayTime,
          OPEN_TIME_END: todayTime

        }
        initData = [...that.data.kbList];
      } else {
        param = {
          method: 'Web.XCX_GetJiaoYiList_BaoMin',
          pageindex: that.data.sbPage,
          pagesize: 10,
          or: 'PUBLISHED_TIME',
          // PUBLISHED_TIME_START: todayTime,
          // PUBLISHED_TIME_END: todayTime
        }
        initData = that.data.sbList;
      }
      param.AREA_CODE = this.data.code;
      ajax({
        url: '/Search/GetData/GetDataHandler.ashx',
        data: param
      }).then((res) => {
        var data = [...initData, ...res.data.data.data],
          total = Math.ceil(res.data.data.total / 10)
        if (data.length) {
          let isMessage = false, listMsg = '';
          if (total == 1) {
            isMessage = true
            listMsg = '已获取全部数据'
          }
          that.setData({
            [bidType[type]]: data,
            bidList: [...data],
            [bidType[type + 'Total']]: total,
            isMessage: isMessage,
            isLoad: false,
            listMsg: listMsg
          })
        } else {
          this.setData({
            bidList: [],
            listMsg: '暂无数据',
            isMessage: true,
            isLoad: false
          })
        }
      })
    }
    
  },
  cutBidType(e) {
    var val = e.currentTarget.dataset.type,
      bidType = {
        kb: 'kbList',
        sb: 'sbList'
      }
    if (val == this.data.bidType){
      return
    };
    this.setData({
      bidType: val,
      isLoding: false,
      isMessage:false
    })
    if (!this.data[bidType[val]].length) {
      this.fetchBidList()
    }else{
      this.setData({
        bidList: [...this.data[bidType[val]]]
      })
    };
  },
  getSumData(){
    ajax({ //获取交易汇总
      url: '/Search/GetData/GetDataHandler.ashx',
      data: {
        method: 'Web.XCX_GetCountAmount',
        AREA_CODE: this.data.code
      }
    }).then((res) => {
      var data = res.data.data.data
      this.setData({
        dealData: data
      })
    })
  },
  getIndexData() {
    this.getSumData()

    ajax({ //获取行业类型
      url: '/Search/GetData/GetDataHandler.ashx',
      data: {
        method: 'Web.XCX_GetGroupByType'
      }
    }).then((res) => {
      var data = res.data.data.data
      this.setData({
        indexmenu: data
      })
    })
    
    ajax({ //轮播图
      url: '/Search/GetData/GetDataHandler.ashx',
      data: {
        method: 'Web.GetNewsList',
        in_type: '0d081bb7-c771-4b8b-8c3d-53f0d9c7d419',
        pageindex: 1,
        pagesize: 5
      }
    }).then((res) => {
      var data = res.data.data.data
      this.setData({
        banner: data
      })
    })
    this.fetchBidList(true)
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    if(!app.sessionid){
      initBase()
    }
    this.getIndexData()
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function() {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function() {
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function() {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function() {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function() {
    console.log('Down')
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function() {
    var bidType = this.data.bidType,
      kbTotalPage = this.data.kbTotalPage,
      sbTotalPage = this.data.sbTotalPage,
      kbPage = this.data.kbPage,
      sbPage = this.data.sbPage,
      isMessage = this.data.isMessage;

    if (bidType == 'kb' && (kbPage < kbTotalPage) && !isMessage) {
      this.data.kbPage = ++kbPage
      console.log(this.data.kbPage && !isMessage)
    } else if (bidType == 'sb' && (sbPage < sbTotalPage)) {
      this.data.sbPage = ++sbPage
    } else if ((!(kbPage < kbTotalPage) || !(sbPage < sbTotalPage))&& !isMessage) {
      this.setData({
        listMsg: '已获取全部数据',
        isMessage: true,
        isLoad:false
      })
      return
    } else {
      return
    }

    this.setData({
      listMsg: '数据加载中...',
      isMessage: true,
      isLoad:true
    })
    setTimeout(() => {
      this.fetchBidList()
    }, 1500)

  },
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function() {

  }
})
